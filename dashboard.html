<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SignalScout AI Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0B1120; color: #cbd5e1; }
    .signal-card { background-color: #1E293B; border: 1px solid #334155; }
    .signal-card:hover { border-color: #3b82f6; transform: translateY(-4px); transition: all 0.2s; }
    .signal-card blockquote { border-left: 3px solid #3b82f6; padding-left: 1.5rem; color: #d1d5db; font-style: italic; }
    .signal-type-badge { font-size: 0.75rem; font-weight: 500; padding: 0.25rem 0.75rem; border-radius: 9999px; background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.5); }
    
    /* Comprehensive Choices.js dark theme override */
    .choices {
      margin: 0;
    }
    
    .choices__inner {
      background-color: #1E293B !important;
      border: 1px solid #475569 !important;
      border-radius: 0.375rem !important;
      padding: 0.5rem 0.75rem !important;
      min-height: 2.75rem !important;
    }
    
    .choices__inner:focus-within {
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }
    
    .choices__input {
      background-color: transparent !important;
      color: #64748b !important;
      font-size: 0.875rem !important;
    }
    
    .choices__input::placeholder {
      color: #64748b !important;
    }
    
    .choices__list {
      max-height: 200px !important;
    }
    
    .choices__list--dropdown {
      background-color: #0f172a !important;
      border: 1px solid #3b82f6 !important;
      border-radius: 0.375rem !important;
      margin-top: 0.25rem !important;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5) !important;
    }
    
    .choices__list--dropdown .choices__item {
      color: #e2e8f0 !important;
      background-color: #0f172a !important;
      padding: 0.625rem 1rem !important;
    }
    
    .choices__item--choice {
      color: #e2e8f0 !important;
      background-color: #0f172a !important;
    }
    
    .choices__item--choice:hover {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }
    
    .choices__item--choice.is-highlighted {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }
    
    .choices__item--selectable {
      color: #e2e8f0 !important;
    }
    
    .choices__item--selectable:hover {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }
    
    .choices__item.is-selected {
      background-color: rgba(59, 130, 246, 0.3) !important;
      color: #60a5fa !important;
    }
    
    .choices__button {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
      border-color: #3b82f6 !important;
    }
    
    .choices__button:hover {
      background-color: #2563eb !important;
      border-color: #2563eb !important;
    }
    
    .choices__placeholder {
      color: #94a3b8 !important;
    }
    
    .filter-group label { 
      color: #cbd5e1; 
      font-size: 0.9rem; 
      margin-bottom: 0.5rem; 
      display: block;
      font-weight: 500;
    }
    
    .search-input {
      background-color: #1E293B;
      border: 1px solid #475569;
      color: #e2e8f0;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      width: 100%;
    }
    .search-input::placeholder {
      color: #64748b;
    }
    .search-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .favorite-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      padding: 0.25rem;
      transition: all 0.2s;
      color: #64748b;
    }
    .favorite-btn:hover {
      color: #fbbf24;
      transform: scale(1.2);
    }
    .favorite-btn.favorited {
      color: #fbbf24;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-300">
  <header class="w-full p-6 flex justify-between items-center container mx-auto border-b border-gray-800">
    <a href="/" class="text-xl font-bold text-white">SignalScout AI</a>
    <nav class="flex items-center space-x-6 text-sm">
      <a href="privacy-policy.html" class="text-gray-400 hover:text-white">Privacy</a>
      <a href="terms-of-service.html" class="text-gray-400 hover:text-white">T&C</a>
      <a href="#" data-ms-action="profile" class="btn-secondary py-2 px-4 rounded-lg">Account</a>
      <a href="#" data-ms-action="logout" class="text-gray-400 hover:text-white">Log Out</a>
    </nav>
  </header>

  <main class="container mx-auto px-6 py-10">
    <h1 class="text-4xl font-bold text-white mb-8">Your Signal Feed</h1>

    <!-- Search Filter -->
    <div class="mb-6">
      <input 
        type="text" 
        id="search-input" 
        class="search-input" 
        placeholder="Search by person, title, company, quote, or source..."
      />
    </div>

    <!-- Filters -->
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6" id="filters"></div>

    <div class="mb-6 flex gap-3 items-center flex-wrap">
      <button onclick="clearFilters()" class="text-sm text-blue-400 border border-blue-400 px-4 py-2 rounded hover:bg-blue-400 hover:text-white">Clear Filters</button>
      <button id="favorites-only-btn" onclick="toggleFavoritesOnly()" class="text-sm text-amber-400 border border-amber-400 px-4 py-2 rounded hover:bg-amber-400 hover:text-white">Show Favorites Only</button>
      <span class="text-sm text-gray-400"><span id="total-results">0</span> results found</span>
    </div>

    <div id="signal-feed" class="flex flex-wrap -mx-3"></div>

    <!-- Pagination -->
    <div id="pagination" class="mt-12 flex justify-center items-center gap-4 pb-10 flex-wrap">
      <button onclick="previousPage()" id="prev-btn" class="text-sm text-blue-400 border border-blue-400 px-4 py-2 rounded hover:bg-blue-400 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed">← Previous</button>
      <span id="page-info" class="text-gray-400 text-sm font-medium">Page 1 of 1</span>
      <button onclick="nextPage()" id="next-btn" class="text-sm text-blue-400 border border-blue-400 px-4 py-2 rounded hover:bg-blue-400 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed">Next →</button>
    </div>
  </main>

  <footer class="text-center py-10 px-6 border-t border-gray-800 text-gray-500 text-sm">
    <div class="space-x-6 mb-4">
      <a href="./terms-of-service.html" class="hover:text-white">Terms of Service</a>
      <a href="./privacy-policy.html" class="hover:text-white">Privacy Policy</a>
    </div>
    <p>&copy; 2025 SignalScout AI. All rights reserved.</p>
  </footer>

  <!-- MemberStack script must come before usage -->
  <script data-memberstack-app="app_cmfu0bt8h002n0wubdfa67lp6" src="https://static.memberstack.com/scripts/v1/memberstack.js" type="text/javascript"></script>

  <script>
    const API_KEY = 'patQZunGJdbMIjNaG.388cc8dfbf3fae8e01d98bd7d112f8fd3476c62131361cc65abedafdfe51afb0';
    const BASE_ID = 'appLmGqJQ0olQo4es';
    const TABLE_NAME = 'Signals';
    const container = document.getElementById('signal-feed');
    const filtersDiv = document.getElementById('filters');
    const searchInput = document.getElementById('search-input');

    let allData = [];
    let choicesInstances = {};
    const fieldsToFilter = ['Person', 'Title', 'Company', 'Source Name'];

    let favorites = new Set();
    let showFavoritesOnly = false;
    const CARDS_PER_PAGE = 36;
    let currentPage = 1;
    let filteredData = [];

    function createSignalCard(signal) {
      const person = signal.Person || 'N/A';
      const title = signal.Title || 'No Title';
      const company = signal.Company || 'No Company';
      const quote = signal.Quote || 'No Quote Available';
      const sourceName = signal['Source Name'] || 'Unknown Source';
      const sourceUrl = signal['Source URL'] || '#';
      const sourceType = signal['Source Type'] || '';
      const rawDate = signal['Publication Date'];
      const pubDate = rawDate ? new Date(rawDate).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }) : '';
      const signalId = signal.id;
      const isFavorited = favorites.has(signalId);

      return `<div class="w-full md:w-1/2 lg:w-1/3 px-3 mb-6 signal-card-wrapper">
        <div class="signal-card p-6 rounded-2xl h-full flex flex-col justify-between">
          <div class="flex justify-between items-start mb-4">
            <div>
              <p class="text-white font-bold text-lg">${person}</p>
              <p class="text-sm text-gray-400">${title} at ${company}</p>
            </div>
            <div class="flex items-center gap-2">
              ${sourceType ? `<div class="signal-type-badge">${sourceType}</div>` : ''}
              <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="toggleFavorite('${signalId}')" title="Add to favorites">
                <i class="fas fa-star" style="opacity: ${isFavorited ? '1' : '0.4'}"></i>
              </button>
            </div>
          </div>
          <blockquote class="mb-4">"${quote}"</blockquote>
          <div class="pt-4 border-t border-gray-700 flex justify-between items-center">
            <a href="${sourceUrl}" target="_blank" class="text-blue-400 text-sm font-semibold hover:text-blue-300">View Source →</a>
            ${pubDate ? `<span class="text-xs text-gray-500">${pubDate}</span>` : ''}
          </div>
        </div>
      </div>`;
    }

    function renderCards(data) {
      container.innerHTML = data.map(createSignalCard).join('');
      if (data.length > 0) {
        setTimeout(() => {
          new Masonry(container, { itemSelector: '.signal-card-wrapper', percentPosition: true });
        }, 0);
      }
    }

    function updatePagination() {
      const totalResults = filteredData.length;
      const totalPages = Math.ceil(totalResults / CARDS_PER_PAGE) || 1;
      
      // Ensure current page is valid
      if (currentPage > totalPages) {
        currentPage = totalPages;
      }
      
      const startIdx = (currentPage - 1) * CARDS_PER_PAGE;
      const endIdx = Math.min(startIdx + CARDS_PER_PAGE, totalResults);
      const pageData = filteredData.slice(startIdx, endIdx);
      
      // Update results counter
      document.getElementById('total-results').textContent = totalResults;
      
      // Render cards for current page only
      renderCards(pageData);
      
      // Update page info
      const pageInfo = document.getElementById('page-info');
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      
      // Update button states
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage >= totalPages;
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredData.length / CARDS_PER_PAGE) || 1;
      if (currentPage < totalPages) {
        currentPage++;
        updatePagination();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        updatePagination();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function setupFilters(data) {
      filtersDiv.innerHTML = '';
      fieldsToFilter.forEach(field => {
        const unique = [...new Set(data.map(d => d[field]).filter(Boolean))].sort();
        const wrapper = document.createElement('div');
        wrapper.className = 'filter-group';
        wrapper.innerHTML = `<label>${field}</label><select id="filter-${field}" multiple></select>`;
        filtersDiv.appendChild(wrapper);

        const select = wrapper.querySelector('select');
        unique.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          select.appendChild(opt);
        });

        const choice = new Choices(select, { 
          removeItemButton: true, 
          placeholder: true, 
          placeholderValue: `Select ${field}`,
          searchResultLimit: 10,
          searchFields: ['value', 'label'],
          shouldSort: false
        });
        choicesInstances[field] = choice;
        select.addEventListener('change', applyFilters);
      });
    }

    function applyFilters() {
      let filtered = [...allData];
      
      // Apply dropdown filters
      fieldsToFilter.forEach(field => {
        const selected = choicesInstances[field].getValue(true);
        if (selected && selected.length > 0) {
          filtered = filtered.filter(d => selected.includes(d[field]));
        }
      });

      // Apply search filter
      const searchTerm = searchInput.value.toLowerCase().trim();
      if (searchTerm) {
        filtered = filtered.filter(d => {
          const searchFields = [
            d.Person || '',
            d.Title || '',
            d.Company || '',
            d.Quote || '',
            d['Source Name'] || ''
          ].join(' ').toLowerCase();
          return searchFields.includes(searchTerm);
        });
      }

      // Apply favorites filter
      if (showFavoritesOnly) {
        filtered = filtered.filter(d => favorites.has(d.id));
      }

      filteredData = filtered;
      currentPage = 1;
      updatePagination();
    }

    function toggleFavorite(signalId) {
      if (favorites.has(signalId)) {
        favorites.delete(signalId);
      } else {
        favorites.add(signalId);
      }
      updatePagination();
    }

    function toggleFavoritesOnly() {
      showFavoritesOnly = !showFavoritesOnly;
      const btn = document.getElementById('favorites-only-btn');
      if (showFavoritesOnly) {
        btn.classList.add('bg-amber-400', 'text-gray-900');
        btn.classList.remove('text-amber-400', 'border-amber-400');
      } else {
        btn.classList.remove('bg-amber-400', 'text-gray-900');
        btn.classList.add('text-amber-400', 'border-amber-400');
      }
      applyFilters();
    }

    function clearFilters() {
      Object.values(choicesInstances).forEach(c => c.clearStore());
      searchInput.value = '';
      showFavoritesOnly = false;
      document.getElementById('favorites-only-btn').classList.remove('bg-amber-400', 'text-gray-900');
      document.getElementById('favorites-only-btn').classList.add('text-amber-400', 'border-amber-400');
      applyFilters();
    }

    async function fetchSignals() {
      try {
        const url = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}?sort[0][field]=Publication%20Date&sort[0][direction]=desc`;
        const res = await fetch(url, { headers: { Authorization: `Bearer ${API_KEY}` } });
        const json = await res.json();
        const records = json.records.map(r => ({ ...r.fields, id: r.id }));
        allData = records;
        filteredData = records;
        setupFilters(records);
        updatePagination();
      } catch (error) {
        console.error('Error fetching signals:', error);
      }
    }

    // Event listener for search input
    searchInput.addEventListener('input', applyFilters);

    if (window.MemberStack && MemberStack.onReady) {
      MemberStack.onReady.then(member => {
        console.log("MemberStack ready");
        fetchSignals();
      });
    } else {
      console.warn("MemberStack not available, loading anyway");
      fetchSignals();
    }
  </script>
</body>
</html>