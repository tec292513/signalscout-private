<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>SignalScout AI Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Choices.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #0B1120;
        color: #cbd5e1;
      }
      .btn-secondary {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: background-color 0.3s ease;
      }
      .btn-secondary:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      .signal-card {
        background-color: #1E293B;
        border: 1px solid #334155;
        transition: all 0.2s ease-in-out;
      }
      .signal-card:hover {
        border-color: #3b82f6;
        transform: translateY(-4px);
      }
      .signal-card blockquote {
        border-left: 3px solid #3b82f6;
        padding-left: 1.5rem;
        color: #d1d5db;
        font-style: italic;
      }
    </style>
  </head>

  <body class="bg-gray-900 text-gray-300">
    <header class="w-full p-6 flex justify-between items-center container mx-auto border-b border-gray-800">
      <a href="/" class="text-xl font-bold text-white">SignalScout AI</a>
      <nav class="flex items-center space-x-6 text-sm">
        <a href="privacy-policy.html" class="text-gray-400 hover:text-white">Privacy</a>
        <a href="terms-of-service.html" class="text-gray-400 hover:text-white">T&C</a>
        <a href="#" class="btn-secondary py-2 px-4 rounded-lg">Account</a>
        <a href="#" class="text-gray-400 hover:text-white">Log Out</a>
      </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
      <h1 class="text-4xl font-bold text-white mb-8">Your Signal Feed</h1>

      <input id="searchInput" type="text" placeholder="Search signals..." class="w-full mb-6 px-4 py-2 rounded-md bg-gray-800 text-white border border-gray-700" />

      <div class="grid md:grid-cols-5 gap-4 text-sm mb-6">
        <select id="filter-name" multiple></select>
        <select id="filter-title" multiple></select>
        <select id="filter-company" multiple></select>
        <select id="filter-source" multiple></select>
        <select id="filter-date" multiple></select>
      </div>

      <button id="clearFilters" class="mb-6 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600 text-sm">Clear Filters</button>

      <div id="signal-feed" class="grid gap-6 md:grid-cols-2 xl:grid-cols-3"></div>
    </main>

    <script>
      const AIRTABLE_API_KEY = 'patQZunGJdbMIjNaG.388cc8dfbf3fae8e01d98bd7d112f8fd3476c62131361cc65abedafdfe51afb0';
      const AIRTABLE_BASE_ID = 'appLmGqJQ0olQo4es';
      const AIRTABLE_TABLE_NAME = 'Signals';

      let allSignals = [];
      let filterInstances = {};

      const fields = {
        name: "Person",
        title: "Title",
        company: "Company",
        source: "Source Name",
        date: "Publication Date"
      };

      function initDropdowns(options) {
        Object.entries(fields).forEach(([id, key]) => {
          const select = document.getElementById(`filter-${id}`);
          select.innerHTML = options[id].sort().map(val => {
            return `<option value="${val}">${val}</option>`;
          }).join("");
          filterInstances[id] = new Choices(select, {
            removeItemButton: true,
            shouldSort: false
          });
        });
      }

      function getActiveFilters() {
        const active = {};
        Object.entries(filterInstances).forEach(([key, instance]) => {
          const selected = instance.getValue(true);
          if (selected.length > 0) active[key] = selected;
        });
        return active;
      }

      function applyFilters() {
        const searchVal = document.querySelector("#searchInput").value.trim().toLowerCase();
        const active = getActiveFilters();

        const filtered = allSignals.filter(signal => {
          for (const key in active) {
            let val = signal[fields[key]];
            if (key === "date") {
              val = new Date(val).toISOString().split("T")[0];
            }
            if (!active[key].includes(val)) return false;
          }
          if (searchVal && !JSON.stringify(signal).toLowerCase().includes(searchVal)) return false;
          return true;
        });

        renderSignals(filtered);
      }

      function renderSignals(signals) {
        const container = document.getElementById("signal-feed");
        container.innerHTML = signals.map(signal => {
          return `
            <div class="signal-card p-5 rounded-lg shadow">
              <h2 class="text-xl font-semibold mb-2 text-white">${signal.Title || "No Title"}</h2>
              <p class="text-sm text-gray-400 mb-1"><strong>${signal.Person || "No Name"}</strong> at <strong>${signal.Company || "No Company"}</strong></p>
              <p class="text-sm text-gray-400 mb-1">${signal["Source Name"] || "No Source"} â€“ ${signal["Publication Date"] || "No Date"}</p>
              <blockquote class="mt-3">${signal.Quote || "No content available."}</blockquote>
            </div>`;
        }).join("");
      }

      document.getElementById("searchInput").addEventListener("input", applyFilters);
      document.getElementById("clearFilters").addEventListener("click", () => {
        Object.values(filterInstances).forEach(instance => instance.clearStore());
        document.querySelector("#searchInput").value = "";
        applyFilters();
      });

      async function fetchSignals() {
        const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(AIRTABLE_TABLE_NAME)}?sort[0][field]=Publication%20Date&sort[0][direction]=desc`;
        try {
          const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
          });
          const data = await response.json();
          allSignals = data.records.map(r => r.fields);

          const options = {
            name: [...new Set(allSignals.map(s => s.Person).filter(Boolean))],
            title: [...new Set(allSignals.map(s => s.Title).filter(Boolean))],
            company: [...new Set(allSignals.map(s => s.Company).filter(Boolean))],
            source: [...new Set(allSignals.map(s => s["Source Name"]).filter(Boolean))],
            date: [...new Set(allSignals.map(s => s["Publication Date"]).filter(Boolean).map(d => new Date(d).toISOString().split("T")[0]))]
          };

          initDropdowns(options);
          applyFilters();
        } catch (err) {
          document.getElementById("signal-feed").innerHTML = `<div class='p-12 bg-red-900/50 text-center rounded-lg'>Error: ${err.message}</div>`;
        }
      }

      fetchSignals();
    </script>
  </body>
</html>
