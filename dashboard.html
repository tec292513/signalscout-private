<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Signal Feed Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
  <style>
    body {
      background-color: #0B1120;
      color: #cbd5e1;
      font-family: 'Inter', sans-serif;
    }
    .signal-card {
      background-color: #1E293B;
      border: 1px solid #334155;
      padding: 1.5rem;
      border-radius: 1rem;
      transition: 0.2s;
    }
    .signal-card:hover {
      border-color: #3b82f6;
      transform: translateY(-4px);
    }
    .signal-card blockquote {
      border-left: 4px solid #3b82f6;
      padding-left: 1rem;
      color: #d1d5db;
      font-style: italic;
    }
    .dropdown {
      background-color: #1E293B;
      color: white;
      border: 1px solid #334155;
      border-radius: 0.5rem;
      padding: 0.5rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .dropdown label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    .filter-header {
      color: #94a3b8;
      font-weight: 600;
    }
    .dropdown-toggle {
      background-color: #1E293B;
      color: #94a3b8;
      padding: 0.5rem;
      border: 1px solid #334155;
      border-radius: 0.5rem;
      cursor: pointer;
      width: 200px;
      text-align: left;
    }
    .dropdown-menu {
      display: none;
      position: absolute;
      z-index: 10;
      margin-top: 0.25rem;
    }
    .dropdown-wrapper {
      position: relative;
    }
    .dropdown-wrapper.open .dropdown-menu {
      display: block;
    }
  </style>
</head>
<body class="px-6 py-10">

  <input id="searchInput" type="text" placeholder="Search Signals..." class="w-full mb-6 px-4 py-2 rounded-md bg-gray-800 text-white border border-gray-700" />

  <div class="flex flex-wrap gap-4 mb-6">
    <div class="dropdown-wrapper" data-key="name">
      <div class="dropdown-toggle">Name</div>
      <div class="dropdown-menu dropdown" id="filter-name"></div>
    </div>
    <div class="dropdown-wrapper" data-key="title">
      <div class="dropdown-toggle">Title</div>
      <div class="dropdown-menu dropdown" id="filter-title"></div>
    </div>
    <div class="dropdown-wrapper" data-key="company">
      <div class="dropdown-toggle">Company</div>
      <div class="dropdown-menu dropdown" id="filter-company"></div>
    </div>
    <div class="dropdown-wrapper" data-key="source">
      <div class="dropdown-toggle">Source</div>
      <div class="dropdown-menu dropdown" id="filter-source"></div>
    </div>
    <div class="dropdown-wrapper" data-key="date">
      <div class="dropdown-toggle">Date</div>
      <div class="dropdown-menu dropdown" id="filter-date"></div>
    </div>
  </div>

  <button id="clearFilters" class="mb-10 px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">Clear Filters</button>

  <div id="signal-feed" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>

  <script>
    const AIRTABLE_API_KEY = 'patQZunGJdbMIjNaG.388cc8dfbf3fae8e01d98bd7d112f8fd3476c62131361cc65abedafdfe51afb0';
    const AIRTABLE_BASE_ID = 'appLmGqJQ0olQo4es';
    const AIRTABLE_TABLE_NAME = 'Signals';

    let allSignals = [];

    function formatDate(d) {
      return new Date(d).toISOString().split("T")[0];
    }

    function groupDates(dates) {
      const map = {};
      dates.forEach(date => {
        const [y, m, d] = date.split("-");
        if (!map[y]) map[y] = {};
        if (!map[y][m]) map[y][m] = [];
        map[y][m].push(d);
      });
      return map;
    }

    function renderDateFilter(dates) {
      const grouped = groupDates(dates);
      const container = document.getElementById("filter-date");
      container.innerHTML = "";
      Object.keys(grouped).sort().forEach(y => {
        const yDiv = document.createElement("div");
        yDiv.classList.add("mb-1");
        const yLabel = document.createElement("div");
        yLabel.textContent = y;
        yLabel.classList.add("filter-header");
        yDiv.appendChild(yLabel);
        Object.keys(grouped[y]).sort().forEach(m => {
          const mDiv = document.createElement("div");
          mDiv.style.marginLeft = "1rem";
          const mLabel = document.createElement("div");
          mLabel.textContent = m;
          mLabel.classList.add("filter-header");
          mDiv.appendChild(mLabel);
          grouped[y][m].sort().forEach(d => {
            const full = `${y}-${m}-${d}`;
            const lbl = document.createElement("label");
            lbl.innerHTML = `<input type="checkbox" class="filter-date" value="${full}"> ${d}`;
            mDiv.appendChild(lbl);
          });
          yDiv.appendChild(mDiv);
        });
        container.appendChild(yDiv);
      });
    }

    function renderFilterOptions(key, values) {
      const container = document.getElementById(`filter-${key}`);
      container.innerHTML = values.sort().map(v =>
        `<label><input type="checkbox" class="filter-${key}" value="${v}"> ${v}</label>`
      ).join('');
    }

    function matchesFilters(signal, active) {
      for (const key in active) {
        if (key === 'date') {
          const formatted = formatDate(signal['Publication Date']);
          if (!active[key].includes(formatted)) return false;
        } else {
          if (!active[key].includes(signal[key])) return false;
        }
      }
      return true;
    }

    function matchesSearch(signal, search) {
      if (!search) return true;
      const str = JSON.stringify(signal).toLowerCase();
      return str.includes(search.toLowerCase());
    }

    function applyFilters() {
      const searchVal = document.querySelector("#searchInput").value.trim();
      const active = {};
      ['name', 'title', 'company', 'source', 'date'].forEach(key => {
        const checked = [...document.querySelectorAll(`.filter-${key}:checked`)];
        if (checked.length) active[key] = checked.map(i => i.value);
      });
      const filtered = allSignals.filter(s => matchesFilters(s, active) && matchesSearch(s, searchVal));
      renderSignals(filtered);
    }

    function createSignalCard(data) {
      const date = formatDate(data["Publication Date"]);
      return `
        <div class="signal-card">
          <h2 class="text-xl font-bold mb-2">${data.Title || "No Title"}</h2>
          <p class="text-sm mb-1"><strong>${data.Person || "Unknown"}</strong> at <strong>${data.Company || "Unknown"}</strong></p>
          <p class="text-xs mb-2 text-blue-300">${data["Source Name"] || ""} â€” ${date}</p>
          <blockquote class="text-sm">${data.Description || ""}</blockquote>
        </div>
      `;
    }

    function renderSignals(data) {
      const container = document.getElementById("signal-feed");
      container.innerHTML = data.map(d => `<div>${createSignalCard(d)}</div>`).join('');
      new Masonry(container, { itemSelector: 'div', percentPosition: true });
    }

    async function fetchSignals() {
      const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(AIRTABLE_TABLE_NAME)}?sort%5B0%5D%5Bfield%5D=Publication%20Date&sort%5B0%5D%5Bdirection%5D=desc`;
      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` }
      });
      const json = await res.json();
      allSignals = json.records.map(r => r.fields);

      const getUniques = key => [...new Set(allSignals.map(s => s[key]).filter(Boolean))];
      renderFilterOptions("name", getUniques("Person"));
      renderFilterOptions("title", getUniques("Title"));
      renderFilterOptions("company", getUniques("Company"));
      renderFilterOptions("source", getUniques("Source Name"));
      renderDateFilter(allSignals.map(s => formatDate(s["Publication Date"])).filter(Boolean));

      renderSignals(allSignals);
    }

    document.querySelectorAll(".dropdown-toggle").forEach(btn => {
      btn.addEventListener("click", () => {
        const parent = btn.closest(".dropdown-wrapper");
        parent.classList.toggle("open");
      });
    });

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.getElementById("clearFilters").addEventListener("click", () => {
      document.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
      document.getElementById("searchInput").value = "";
      renderSignals(allSignals);
    });
    document.addEventListener("change", e => {
      if (e.target.matches("input[type=checkbox]")) applyFilters();
    });

    fetchSignals();
  </script>
</body>
</html>
