<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Signal Feed</title>
  <style>
    body {
      background-color: #0e1320;
      color: white;
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      font-size: 2.5em;
      font-weight: bold;
    }
    input, select {
      padding: 10px;
      border: 1px solid #555;
      background-color: #1c2230;
      color: white;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    input::placeholder, select option[disabled] {
      color: #aaa;
    }
    .filters, .card {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .card {
      background: #1c2230;
      padding: 20px;
      border-radius: 8px;
      margin-top: 10px;
      flex-direction: column;
    }
    .dropdown {
      background-color: #1c2230;
      color: white;
    }
    button {
      background-color: #3a4255;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      margin-top: 10px;
    }
    select optgroup {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Your Signal Feed</h1>

  <input id="search" type="text" placeholder="Search signals..." style="width: 100%;" />

  <div class="filters">
    <select id="nameSelect">
      <option disabled selected>Name</option>
    </select>
    <select id="titleSelect">
      <option disabled selected>Select title</option>
    </select>
    <select id="companySelect">
      <option disabled selected>Select company</option>
    </select>
    <select id="sourceSelect">
      <option disabled selected>Select source</option>
    </select>
    <select id="dateSelect">
      <option disabled selected>Select date</option>
    </select>
  </div>

  <button onclick="clearFilters()">Clear Filters</button>

  <div id="results"></div>

  <script>
    const AIRTABLE_API_KEY = 'patQZunGJdbMIjNaG.388cc8dfbf3fae8e01d98bd7d112f8fd3476c62131361cc65abedafdfe51afb0';
    const AIRTABLE_BASE_ID = 'appLmGqJQ0olQo4es';
    const AIRTABLE_TABLE_NAME = 'Signals';
    const filterElements = ['search', 'nameSelect', 'titleSelect', 'companySelect', 'sourceSelect', 'dateSelect'];

    let allRecords = [];

    async function fetchData() {
      const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?pageSize=100`;
      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` },
      });
      const data = await res.json();
      allRecords = data.records;
      populateFilters(allRecords);
      displayCards(allRecords);
    }

    function populateFilters(records) {
      const nameSet = new Set();
      const titleSet = new Set();
      const companySet = new Set();
      const sourceSet = new Set();
      const dateSet = new Map();

      records.forEach(record => {
        const f = record.fields;
        if (f.Name) nameSet.add(f.Name);
        if (f.Title) titleSet.add(f.Title);
        if (f.Company) companySet.add(f.Company);
        if (f.Source) sourceSet.add(f.Source);
        if (f.Date) {
          const date = new Date(f.Date);
          const y = date.getFullYear();
          const m = date.toLocaleString('default', { month: 'long' });
          const d = date.getDate();
          if (!dateSet.has(y)) dateSet.set(y, new Map());
          if (!dateSet.get(y).has(m)) dateSet.get(y).set(m, new Set());
          dateSet.get(y).get(m).add(d);
        }
      });

      setOptions('nameSelect', nameSet);
      setOptions('titleSelect', titleSet);
      setOptions('companySelect', companySet);
      setOptions('sourceSelect', sourceSet);
      setDateDropdown(dateSet);
    }

    function setOptions(id, values) {
      const select = document.getElementById(id);
      [...values].sort().forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      });
    }

    function setDateDropdown(dateMap) {
      const select = document.getElementById('dateSelect');
      for (let [year, months] of [...dateMap.entries()].sort()) {
        const yGroup = document.createElement('optgroup');
        yGroup.label = year;
        for (let [month, days] of [...months.entries()].sort()) {
          for (let day of [...days].sort((a,b)=>a-b)) {
            const opt = document.createElement('option');
            opt.value = `${year}-${month}-${day}`;
            opt.textContent = `${month} ${day}, ${year}`;
            yGroup.appendChild(opt);
          }
        }
        select.appendChild(yGroup);
      }
    }

    function displayCards(records) {
      const container = document.getElementById('results');
      container.innerHTML = '';
      records.forEach(rec => {
        const f = rec.fields;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${f.Title || ''}</h3>
          <p><strong>${f.Name || ''}</strong> at <strong>${f.Company || ''}</strong></p>
          <p>${f.Source || ''} â€“ ${f.Date || ''}</p>
          <p><em>${f.Content ? f.Content.slice(0, 100) + '...' : ''}</em></p>
        `;
        container.appendChild(card);
      });
    }

    function clearFilters() {
      filterElements.forEach(id => {
        const el = document.getElementById(id);
        if (el.tagName === 'INPUT') el.value = '';
        else el.selectedIndex = 0;
      });
      displayCards(allRecords);
    }

    filterElements.forEach(id => {
      document.getElementById(id).addEventListener('input', applyFilters);
    });

    function applyFilters() {
      let filtered = allRecords;
      const name = document.getElementById('nameSelect').value;
      const title = document.getElementById('titleSelect').value;
      const company = document.getElementById('companySelect').value;
      const source = document.getElementById('sourceSelect').value;
      const date = document.getElementById('dateSelect').value;
      const search = document.getElementById('search').value.toLowerCase();

      filtered = filtered.filter(rec => {
        const f = rec.fields;
        return (!name || f.Name === name)
          && (!title || f.Title === title)
          && (!company || f.Company === company)
          && (!source || f.Source === source)
          && (!date || f.Date === date || f.Date?.includes(date))
          && (!search || Object.values(f).some(val => typeof val === 'string' && val.toLowerCase().includes(search)));
      });

      displayCards(filtered);
    }

    fetchData();
  </script>
</body>
</html>
